# probability-time-series-prediction-SCRS-
#Objective: generate a model to predict probability of changes in three main land covers in the North west territories of Canada. 


#directpro=list.files("C:/My Data/phd/data/paper1/landcover_modeling/git",all.files = FALSE,pattern = "*.tif")


# the map of probabilities for each category of land cover in the SCRS is generated by using GLM model (4 variables)


#stack all the probability maps
pp=raster::stack("1970_pp_4_7y.tif","1970_pp_4_30y.tif","1977_pp_4_23y.tif","1977_pp_4_31y.tif","1970_pp_4_38y.tif")
pb=raster::stack("1970_pB_4_7y.tif","1970_pB_4_30y.tif","1977_pB_4_23y.tif","1977_pB_4_31y.tif","1970_pB_4_38y.tif")
pF=raster::stack("1970_pF_4_7y.tif","1970_pF_4_30y.tif","1977_pF_4_23y.tif","1977_pF_4_31y.tif","1970_pF_4_38y.tif")
bf=raster::stack("1970_bf_4_7y.tif","1970_bf_4_30y.tif","1977_bf_4_23y.tif","1977_bf_4_31y.tif","1970_bf_4_38y.tif")
names(pF)=c('PF(7Years)','PF(23Years)','PF(30Years)','PF(31Years)','PF(38Years)')
names(bf)=c('BF(7Years)','BF(23Years)','BF(30Years)','BF(31Years)','BF(38Years)')
names(pp)=c('PP(7Years)','PP(23Years)','PP(30Years)','PP(31Years)','PP(38Years)')
names(pb)=c('PB(7Years)','PB(23Years)','PB(30Years)','PB(31Years)','PB(38Years)')
VAR4_GLM_ALLYEAR=raster::stack(pF,pb,bf)

#plots
pal <- wesanderson::wes_palette("Zissou1", 50, type = "continuous")
rasterVis:: levelplot(VAR4_GLM_ALLYEAR, col.regions=rev(pal),layout=c(5,3), margin = TRUE, colorkey = list(space = "bottom"), scales=list(draw=FALSE ))


#turn the stacked rasters for each  category to dataframe, the probability maps for each land cover is fpr unequall time step (7,23,30,31,38). Showing the rate of changes in each time step. I am trying to use spatio-temporal interplation to devise a model for predicting the rate annualy.

#trend analysis (category= landcover pp )
time <- ts(c(7,23,30,31,38))
ras <- setZ(pp, time, "Time")
pptime = setZ(pp,c(7,23,30,31,38),"time")








datapp<- as.data.frame(pptime, xy=TRUE)
datapp <- reshape(datapp, direction='long', varying=3:ncol(datapp), v.names='value', timevar='time')
datapp=na.omit(datapp)
datapp$time <- replace(datapp$time, datapp$time==1, 7)
datapp$time <- replace(datapp$time, datapp$time==2, 23)
datapp$time <- replace(datapp$time, datapp$time==3, 30)
datapp$time <- replace(datapp$time, datapp$time==4, 31)
datapp$time <- replace(datapp$time, datapp$time==5, 38)

summary(datapp)



model <- glm(datapp$value~ datapp$time, na.action = na.omit)





calculateSlope <- function(x) {if (is.na(x[1])) {NA} else{ lm(x ~ time)$coefficients[2] }}
calculatebeta<- function(x) {if (is.na(x[1])) {NA} else{ lm(x ~ time)$coefficients[1] }}



slopeRaster <- calc(ras, fun = calculateSlope)
betaRaster <- calc(ras, fun = calculatebeta)

plot(betaRaster)

r_list <- list()
time <- ts(c(7,23,30,31,38))
for (i in time) {
  r_list[[i]] <- setValues(x = pptime, values = rnorm(n = ncell(pptime), mean = i, sd = 0.1))
}


bfun <- function(x) { if (is.na(x[1])){ c(NA, NA) } else {lm(x ~ time)$coefficients}} 
x <- calc(pptime, bfun)
p1 <- p2[[1]] + p2[[2]] * time
pfun <- function(x) { if (is.na(x[1])){ rep(NA, length(x)) } else { predict( lm(x ~ time))}} 
p2 <- calc(ras, pfun)









lm_intercept <- calc(pptime, fun = function(x) {
  if (all(is.na(x)))
    return(NA)
  else
    return(coef(lm(x ~ time))[1])
})

lm_slope <- calc(pptime, fun = function(x) {
  if (all(is.na(x)))
    return(NA)
  else
    return(coef(lm(x ~ time))[2])
})

sss=lm_slope * 50 + lm_intercept













plot(sss)

library(animation)
ani.options(interval=.05)

saveGIF({
  for (i in 1:aaa){
    rclmat <-pptime
    plot(rclmat, legend=FALSE, main = paste("Day", i))
  }
}) 




