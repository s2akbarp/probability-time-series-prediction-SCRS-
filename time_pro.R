# probability-time-series-prediction-SCRS-

directpro=list.files("C:/My Data/phd/data/paper1/landcover_modeling/git",all.files = FALSE,pattern = "*.tif")


# the map of probabilities for each category of land cover in the SCRS is generated by using GLM model (4 variables)



#stack all the probability maps
pp=raster::stack("1970_pp_4_7y.tif","1970_pp_4_30y.tif","1977_pp_4_23y.tif","1977_pp_4_31y.tif","1970_pp_4_38y.tif")
pb=raster::stack("1970_pB_4_7y.tif","1970_pB_4_30y.tif","1977_pB_4_23y.tif","1977_pB_4_31y.tif","1970_pB_4_38y.tif")
pF=raster::stack("1970_pF_4_7y.tif","1970_pF_4_30y.tif","1977_pF_4_23y.tif","1977_pF_4_31y.tif","1970_pF_4_38y.tif")
bf=raster::stack("1970_bf_4_7y.tif","1970_bf_4_30y.tif","1977_bf_4_23y.tif","1977_bf_4_31y.tif","1970_bf_4_38y.tif")
names(pF)=c('PF(7Years)','PF(23Years)','PF(30Years)','PF(31Years)','PF(38Years)')
names(bf)=c('BF(7Years)','BF(23Years)','BF(30Years)','BF(31Years)','BF(38Years)')
names(pp)=c('PP(7Years)','PP(23Years)','PP(30Years)','PP(31Years)','PP(38Years)')
names(pb)=c('PB(7Years)','PB(23Years)','PB(30Years)','PB(31Years)','PB(38Years)')
VAR4_GLM_ALLYEAR=raster::stack(pF,pb,bf)

#time step data frame 

#bf
bftime = setZ(bf,c(7,23,30,31,38),"time")
databf<- as.data.frame(bftime, xy=TRUE)
databf <- reshape(databf,direction='long',varying=3:ncol(databf),v.names='value', timevar='time')
databf$time <- replace(databf$time, databf$time==1, 7)
databf$time <- replace(databf$time, databf$time==2, 23)
databf$time <- replace(databf$time, databf$time==3, 30)
databf$time <- replace(databf$time, databf$time==4, 31)
databf$time <- replace(databf$time, databf$time==5, 38)
databf=na.omit(databf)

#pp

pptime = setZ(pp,c(7,23,30,31,38),"time")
datapp<- as.data.frame(pptime, xy=TRUE)
datapp <- reshape(datapp,direction='long',varying=3:ncol(datapp),v.names='value', timevar='time')
datapp=na.omit(datapp)
datapp$time <- replace(datapp$time, datapp$time==1, 7)
datapp$time <- replace(datapp$time, datapp$time==2, 23)
datapp$time <- replace(datapp$time, datapp$time==3, 30)
datapp$time <- replace(datapp$time, datapp$time==4, 31)
datapp$time <- replace(datapp$time, datapp$time==5, 38)


#plots
pal <- wesanderson::wes_palette("Zissou1", 50, type = "continuous")
rasterVis:: levelplot(VAR4_GLM_ALLYEAR, col.regions=rev(pal),layout=c(5,3), margin = TRUE, colorkey = list(space = "bottom"), scales=list(draw=FALSE ))

#trend analysis (category= landcover pp )

  ##time <- ts(c(7,23,30,31,38))
  ##ras <- setZ(pp, time, "Time")

# linear model pp
time <- ts(c(7,23,30,31,38))
pptime = setZ(pp,c(7,23,30,31,38),"time")
bfun <- function(x) { if (is.na(x[1])){ c(NA, NA) } else {lm(x ~ time)$coefficients}} 
x <- calc(pptime, bfun)
p1 <- x[[1]] + x[[2]] * 200

p1[p1$layer<=0.1] <-NA
p1[p1$layer>1] <- 1

spplot(p1)

# linear model bf
bftime = setZ(bf,c(7,23,30,31,38),"time")
time <- ts(c(7,23,30,31,38))
bffun <- function(x) { if (is.na(x[1])){ c(NA, NA) } else {lm(x ~ time)$coefficients}} 
bftrend <- calc(bftime, bffun)
bfeq <- bftrend[[1]] + bftrend[[2]] * 200

bfeq[bfeq$layer<0] <- 0
bfeq[bfeq$layer>=1] <- NA
spplot(bfeq)



# linear model pb
pbtime = setZ(pb,c(7,23,30,31,38),"time")
time <- ts(c(7,23,30,31,38))
pbfun <- function(x) { if (is.na(x[1])){ c(NA, NA) } else {lm(x ~ time)$coefficients}} 
pbtrend <- calc(pbtime, pbfun)
pbeq <- pbtrend[[1]] + pbtrend[[2]] * 200

pbeq[pbeq$layer<0] <- 0
pbeq[pbeq$layer>=1] <- NA
spplot(pbeq)


# linear model pf
pftime = setZ(pF,c(7,23,30,31,38),"time")
time <- ts(c(7,23,30,31,38))
pffun <- function(x) { if (is.na(x[1])){ c(NA, NA) } else {lm(x ~ time)$coefficients}} 
pftrend <- calc(pftime, pffun)
pfeq <- pftrend[[1]] + pftrend[[2]] * 200

pfeq[pfeq$layer<0] <- 0
pfeq[pfeq$layer>=1] <-NA
spplot(prob100)


prob100=stack(pfeq,pbeq,bfeq,p1)
names(prob100)=c('PF(100Years)','PB(100Years)','BF(100Years)','PP(100Years)')
rasterVis:: levelplot(prob100, col.regions=rev(pal),layout=c(4,1), margin = TRUE, colorkey = list(space = "bottom"), scales=list(draw=FALSE ))





library(animation)
ani.options(interval=.05)

saveGIF({
  for (i in 1:prob100){
    rclmat <-prob100
    plot(prob100, legend=FALSE, main = paste("Day", i))
  }
}) 


